<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JessieMath - é‚è¼¯å·¥ç¨‹éºè·¡ä¿®å¾© </title>
    
    <meta name="description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved. é€éè¶£å‘³çš„éºè·¡ä¿®å¾©å·¥ç¨‹ï¼ŒæŒæ¡é€Ÿç‡ã€å¹´é½¡ã€å¹³å‡èˆ‡é‚è¼¯å•é¡Œï¼">
    <meta property="og:title" content="JessieMath - é‚è¼¯å·¥ç¨‹éºè·¡ä¿®å¾©">
    <meta property="og:type" content="website">

    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Noto+Sans+TC:wght@400;700&family=Fredoka+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- è®Šæ•¸è¨­å®š --- */
        :root {
            --neon-cyan: #00d2d3;
            --neon-orange: #ff9f43;
            --bg-dark: #0f0f1a;
            --panel-bg: rgba(0, 20, 30, 0.85);
            --danger: #ff4757;
            --brand-yellow: #FFD700;
        }

        /* --- å…¨å±€è¨­å®š --- */
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-drag: none;
            touch-action: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
        }

        /* --- èƒŒæ™¯ç‰¹æ•ˆ --- */
        .world-stage {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #000000 0%, #1a1a2e 50%, #2f2f3e 50%, #1e1e2e 100%);
            z-index: 0;
            perspective: 1000px;
        }

        .grid-floor {
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 50%;
            background-image: 
                linear-gradient(rgba(0, 210, 211, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 210, 211, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg);
            transform-origin: center top;
            opacity: 0.3;
        }

        /* --- Header --- */
        header {
            position: relative;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid var(--neon-orange);
            height: 80px;
        }

        .brand-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-circle {
            width: 60px;
            height: 60px;
            background-color: var(--brand-yellow);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border: 3px solid #fff;
            box-shadow: 0 0 10px var(--neon-orange);
            font-weight: bold;
            color: #333;
            font-family: 'Fredoka One', cursive;
        }

        .logo-circle img {
            width: 90%;
            height: auto;
            object-fit: contain;
        }

        .brand-text {
            font-family: 'Fredoka One', cursive;
            font-size: 24px;
            color: #fff;
            letter-spacing: 1px;
            text-shadow: 2px 2px 0 #000;
        }

        .nav-links {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            text-decoration: none;
            color: var(--neon-cyan);
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 11px;
            padding: 5px 10px;
            border: 1px solid rgba(0, 210, 211, 0.3);
            border-radius: 8px;
            transition: all 0.2s;
            background: rgba(0,0,0,0.5);
        }

        .nav-btn:hover {
            background-color: var(--neon-cyan);
            color: #000;
            transform: translateY(-2px);
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 2px;
        }

        /* --- éŠæˆ²ä¸»å€åŸŸ --- */
        .game-container {
            position: relative;
            z-index: 10;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 80px;
        }

        .status-hud {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 160px;
            background: rgba(0, 20, 20, 0.9);
            border: 1px solid var(--neon-cyan);
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .warning-lights {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 5px;
            background: #000;
            padding: 3px;
        }

        .light {
            width: 30px;
            height: 6px;
            background: #333;
            transition: 0.3s;
        }
        .light.active { background: var(--danger); box-shadow: 0 0 8px var(--danger); }

        .timer-gauge {
            position: absolute;
            bottom: 100px;
            left: 20px;
            width: 90px;
            height: 90px;
            background: rgba(0,0,0,0.6);
            border-radius: 50%;
            border: 4px solid var(--neon-orange);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px rgba(255, 159, 67, 0.4);
        }
        .timer-val { font-family: 'Teko', sans-serif; font-size: 36px; color: var(--neon-orange); line-height: 1; }

        .center-stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 800px;
            margin-top: 10px;
        }

        .question-display {
            background: var(--panel-bg);
            border: 1px solid var(--neon-cyan);
            padding: 15px 25px;
            border-radius: 10px;
            color: #fff;
            font-size: 1.2rem;
            text-align: center;
            width: 90%;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(0, 210, 211, 0.2);
            position: relative;
            line-height: 1.6;
        }

        .relic-zone {
            width: 200px;
            height: 200px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s;
        }

        .relic-base {
            position: absolute;
            bottom: -10px;
            width: 180px;
            height: 50px;
            background: radial-gradient(ellipse at center, rgba(0, 210, 211, 0.4) 0%, transparent 70%);
            border-radius: 50%;
            transform: rotateX(60deg);
            animation: pulseBase 2s infinite;
        }
        @keyframes pulseBase {
            0% { opacity: 0.4; transform: rotateX(60deg) scale(1); }
            50% { opacity: 0.7; transform: rotateX(60deg) scale(1.1); }
            100% { opacity: 0.4; transform: rotateX(60deg) scale(1); }
        }

        .relic-img {
            font-size: 90px;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.2));
            z-index: 5;
            transition: all 0.3s;
        }

        .relic-cracked {
            filter: drop-shadow(0 0 15px red) grayscale(50%);
            animation: unstableShake 0.5s infinite;
        }
        @keyframes unstableShake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, -1px) rotate(-1deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }

        .progress-ring {
            position: absolute;
            width: 220px;
            height: 220px;
            transform: rotate(-90deg);
            pointer-events: none;
        }
        .progress-circle {
            fill: none;
            stroke: var(--neon-cyan);
            stroke-width: 6;
            stroke-dasharray: 690;
            stroke-dashoffset: 690;
            transition: stroke-dashoffset 0.5s;
        }

        .toolbox-area {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            width: 100%;
            padding: 0 10px;
            z-index: 50;
            flex-wrap: wrap;
        }

        .tool-card {
            width: 90px;
            height: 100px;
            background: linear-gradient(180deg, #333, #111);
            border: 2px solid #555;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: grab;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        
        .tool-card:active { cursor: grabbing; transform: scale(0.95); }

        .tool-icon { font-size: 30px; margin-bottom: 5px; }
        .tool-value { 
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 18px;
            color: var(--neon-cyan); 
            font-weight: bold;
            background: rgba(0,0,0,0.5);
            width: 100%;
            text-align: center;
            padding: 2px 0;
            white-space: nowrap;
        }

        .tool-card.dragging {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.9;
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--neon-orange);
            border-color: var(--neon-orange);
        }

        /* --- Footer --- */
        footer {
            position: fixed;
            bottom: 15px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 150;
            pointer-events: none;
        }

        .footer-pill {
            background: rgba(15, 15, 26, 0.9);
            border: 1px solid var(--neon-cyan);
            border-radius: 50px;
            padding: 8px 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            backdrop-filter: blur(5px);
            pointer-events: auto;
            box-shadow: 0 0 15px rgba(0, 210, 211, 0.2);
        }

        .footer-left, .footer-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer-dot {
            width: 8px;
            height: 8px;
            background-color: var(--neon-orange);
            border-radius: 50%;
            box-shadow: 0 0 5px var(--neon-orange);
            animation: pulseDot 2s infinite;
        }
        @keyframes pulseDot {
            0% { opacity: 0.5; }
            50% { opacity: 1; box-shadow: 0 0 10px var(--neon-orange); }
            100% { opacity: 0.5; }
        }

        .footer-copy, .footer-tagline { font-size: 12px; color: #ccc; letter-spacing: 0.5px; }
        .footer-right { border-left: 1px solid #555; padding-left: 20px; }
        .footer-icon { color: var(--neon-cyan); font-size: 14px; }

        .repair-anim {
            position: absolute;
            font-size: 50px;
            z-index: 100;
            pointer-events: none;
            animation: working 0.8s ease-in-out;
        }
        @keyframes working {
            0% { transform: rotate(0deg) scale(1); opacity: 1; }
            25% { transform: rotate(-30deg) scale(1.1); }
            50% { transform: rotate(0deg) scale(1); }
            75% { transform: rotate(-30deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(0); opacity: 0; }
        }

        .error-popup {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 71, 87, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            z-index: 200;
            box-shadow: 0 0 30px red;
            pointer-events: none;
            display: none;
            animation: popIn 0.3s;
            white-space: nowrap;
        }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* --- Overlays --- */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-start, .btn-rank {
            border: 2px solid var(--neon-cyan);
            background: transparent;
            color: var(--neon-cyan);
            padding: 10px 30px;
            font-size: 20px;
            font-family: 'Teko', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-start:hover, .btn-rank:hover {
            background: var(--neon-cyan);
            color: #000;
        }

        .btn-rank {
            border-color: var(--brand-yellow);
            color: var(--brand-yellow);
        }
        .btn-rank:hover {
            background: var(--brand-yellow);
            color: #000;
        }

        input[type="text"] {
            background: #222; border: 1px solid #555; color: white; padding: 8px; text-align: center; font-size: 1.2rem; margin-bottom: 10px;
        }

        /* --- Rank Modal --- */
        .modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            background: rgba(15, 15, 30, 0.95);
            border: 2px solid var(--brand-yellow);
            border-radius: 10px;
            z-index: 3000;
            padding: 20px;
            display: none;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        .modal-header {
            font-family: 'Teko', sans-serif;
            font-size: 30px;
            color: var(--brand-yellow);
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        .rank-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #333;
            color: #eee;
        }
        .rank-item:nth-child(1) { color: var(--brand-yellow); font-weight: bold; }
        .rank-item:nth-child(2) { color: silver; }
        .rank-item:nth-child(3) { color: #cd7f32; }

        .close-modal {
            margin-top: 15px;
            background: #333;
            border: none;
            color: white;
            padding: 5px 15px;
            cursor: pointer;
        }

        /* --- RWD --- */
        @media (max-width: 768px) {
            header { padding: 5px 10px; height: 60px; }
            .brand-text { font-size: 18px; }
            .logo-circle { width: 40px; height: 40px; }
            .nav-btn span { display: none; }
            .nav-icon { margin: 0; font-size: 20px; }
            
            .question-display { font-size: 1rem; padding: 10px; margin-bottom: 10px; }
            .relic-zone { width: 160px; height: 160px; margin-top: 5px; }
            .relic-img { font-size: 70px; }
            .progress-ring { width: 180px; height: 180px; }
            
            .toolbox-area { gap: 8px; margin-bottom: 60px; }
            .tool-card { width: 80px; height: 85px; }
            .timer-gauge { width: 60px; height: 60px; bottom: 80px; left: 10px; opacity: 0.8; }
            .timer-val { font-size: 24px; }

            .footer-pill {
                flex-direction: column;
                gap: 5px;
                padding: 8px 15px;
                width: 90%;
                align-items: flex-start;
            }
            .footer-right { border-left: none; padding-left: 0; }
        }
    </style>
</head>
<body>

    <div class="world-stage">
        <div class="grid-floor"></div>
    </div>

    <header>
        <div class="brand-area">
            <div class="logo-circle">
                <img src="JESSIEMATH-Q.png" alt="Logo" onerror="this.style.display='none'; this.parentNode.innerText='JM'">
            </div>
            <div class="brand-text">Jessie Math</div>
        </div>
        <nav class="nav-links">
            <a href="https://jessiemath0703-chu.github.io/website2/" class="nav-btn">
                <span class="nav-icon">ğŸ </span>
                <span>é¦–é </span>
            </a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="nav-btn">
                <span class="nav-icon">ğŸ®</span>
                <span>éŠæˆ²å¤§å»³</span>
            </a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/#g6-u14" class="nav-btn">
                <span class="nav-icon">ğŸ”™</span>
                <span>å›åˆ°å–®å…ƒ</span>
            </a>
        </nav>
    </header>

    <div class="game-container">
        
        <div class="status-hud">
            <div style="display:flex; justify-content:space-between; color: var(--neon-cyan);">
                <span>ä¿®å¾©æ•¸</span>
                <span id="score">0</span>
            </div>
            <div style="font-size: 10px; color: #888; text-align: center; margin-top:5px;">
                çµæ§‹ç©©å®šåº¦ (Stability)
            </div>
            <div class="warning-lights">
                <div class="light" id="light-1"></div>
                <div class="light" id="light-2"></div>
            </div>
        </div>

        <div class="timer-gauge">
            <div class="timer-val" id="timer">90</div>
            <div style="font-size: 10px; color:#aaa;">SEC</div>
        </div>

        <div class="center-stage">
            
            <div class="question-display">
                <span style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:var(--neon-orange); color:black; font-size:12px; padding:2px 8px; border-radius:4px; font-weight:bold;" id="q-category">é¡Œç›®é¡å‹</span>
                <div id="q-text">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
            </div>

            <div class="relic-zone" id="drop-zone">
                <svg class="progress-ring" viewBox="0 0 240 240">
                    <circle class="progress-circle" id="progress-circle" cx="120" cy="120" r="110" />
                </svg>
                <div class="relic-base"></div>
                <div class="relic-img" id="relic-target">ğŸº</div>
                
                <div id="error-msg" class="error-popup">
                    âš ï¸ éŒ¯èª¤!<br>
                    æ­£ç¢ºç­”æ¡ˆæ˜¯: <span id="correct-val" style="font-size:1.3em; color:yellow;"></span>
                </div>
            </div>

        </div>

        <div class="toolbox-area" id="tools-container"></div>

    </div>

    <footer>
        <div class="footer-pill">
            <div class="footer-left">
                <div class="footer-dot" aria-hidden="true"></div>
                <div class="footer-copy">Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.</div>
            </div>
            <div class="footer-right">
                <div class="footer-icon" aria-hidden="true"><i class="fas fa-compass"></i></div>
                <div class="footer-tagline">æ•¸å­¸ä¸è¿·è·¯ï¼ŒJessieå¸¶ä½ èµ°å‘ç†è§£ã€‚</div>
            </div>
        </div>
    </footer>

    <div id="start-screen" class="overlay">
        <h1 style="color:var(--neon-orange); font-family:'Teko'; font-size:50px; margin:0;">éºè·¡ä¿®å¾©å·¥ç¨‹</h1>
        <p style="color:#ccc; font-size:14px; margin-bottom:20px; line-height:1.5;">
            æ‹–æ›³æ­£ç¢ºçš„å·¥å…·èˆ‡æ•¸å€¼ä¾†ä¿®å¾©æ–‡ç‰©ã€‚<br>
            âš ï¸ é€£çºŒå…©æ¬¡å¤±èª¤å°‡å°è‡´çµæ§‹å´©å¡Œã€‚
        </p>
        <input type="text" id="username" placeholder="è«‹è¼¸å…¥ä½ çš„åå­—" autocomplete="off">
        <div class="btn-group">
            <button class="btn-start" id="start-btn">é–‹å§‹ä»»å‹™</button>
            <button class="btn-rank" id="show-rank-btn">ğŸ† æ’è¡Œæ¦œ</button>
        </div>
    </div>

    <div id="rank-modal" class="modal">
        <div class="modal-header">ğŸ† é‚è¼¯å·¥ç¨‹å¸« æ’è¡Œæ¦œ</div>
        <ul class="rank-list" id="rank-list">
            </ul>
        <button class="close-modal" id="close-rank-btn">é—œé–‰</button>
    </div>

    <div id="end-screen" class="overlay" style="display: none;">
        <h1 style="color:var(--danger); font-family:'Teko'; font-size:50px;">ä»»å‹™çµæŸ</h1>
        <p style="font-size:24px;">ä¿®å¾©æ–‡ç‰©æ•¸: <span id="final-score" style="color:var(--brand-yellow)">0</span></p>
        <button class="btn-start" onclick="location.reload()">å†æ¬¡æŒ‘æˆ°</button>
    </div>

    <script>
        // --- å…¨æ–°æ“´å……é¡Œåº« (Based on PDF files: g6-u14) ---
        const fullQuestionBank = [
            // --- é€Ÿç‡å•é¡Œ (ç›¸å‘ã€åŒå‘ã€é›»æ‰¶æ¢¯) ---
            { type: "é€Ÿç‡å•é¡Œ", q: "ç”²åœ°èˆ‡ä¹™åœ°ç›¸è· 480å…¬å°ºï¼Œå°çœŸ(48m/åˆ†)å’Œå°æ™º(32m/åˆ†)åŒæ™‚ç›¸å‘è€Œè¡Œï¼Œè«‹å• <b>å¹¾åˆ†é˜å¾Œ</b> ç›¸é‡ï¼Ÿ", ans: "6åˆ†é˜", options: ["6åˆ†é˜", "10åˆ†é˜", "8åˆ†é˜", "5åˆ†é˜"] },
            { type: "é€Ÿç‡å•é¡Œ", q: "å°çœŸ6åˆ†é˜èµ°288å…¬å°º(48m/åˆ†)ï¼Œå°æ™º1åˆ†é˜èµ°32å…¬å°ºã€‚å…©äººåŒåœ°å‡ºç™¼ï¼ŒèƒŒå‘è€Œè¡Œï¼Œ<b>30åˆ†é˜å¾Œ</b> ç›¸è·å¤šé ï¼Ÿ", ans: "2400å…¬å°º", options: ["2400å…¬å°º", "1600å…¬å°º", "2000å…¬å°º", "1800å…¬å°º"] },
            { type: "é€Ÿç‡å•é¡Œ", q: "çƒé¾œé€Ÿç‡8cm/ç§’ï¼Œå…”å­15cm/ç§’ã€‚åŒæ™‚åŒåœ°<b>åæ–¹å‘</b>å‰é€²ï¼Œ10ç§’å¾Œç›¸è·å¹¾å…¬åˆ†ï¼Ÿ", ans: "230å…¬åˆ†", options: ["230å…¬åˆ†", "70å…¬åˆ†", "200å…¬åˆ†", "150å…¬åˆ†"] },
            { type: "é€Ÿç‡å•é¡Œ", q: "å¹³é¢é›»æ‰¶æ¢¯é€Ÿç‡0.5m/ç§’ï¼Œåª½åª½è¡Œèµ°é€Ÿç‡48m/åˆ†(=0.8m/ç§’)ã€‚åœ¨é›»æ‰¶æ¢¯ä¸Š<b>åŒå‘è¡Œèµ°</b>10ç§’ï¼Œç§»å‹•å¹¾å…¬å°ºï¼Ÿ", ans: "13å…¬å°º", options: ["13å…¬å°º", "8å…¬å°º", "5å…¬å°º", "10å…¬å°º"] },
            { type: "é€Ÿç‡å•é¡Œ", q: "ç¶­ä¿®å“¡åœ¨å¹³é¢é›»æ‰¶æ¢¯ä¸Š<b>åå‘è¡Œèµ°</b>ï¼Œé€Ÿç‡45m/åˆ†(=0.75m/ç§’)ï¼Œé›»æ‰¶æ¢¯0.5m/ç§’ã€‚10ç§’å¾Œç§»å‹•å¹¾å…¬å°ºï¼Ÿ", ans: "2.5å…¬å°º", options: ["2.5å…¬å°º", "12.5å…¬å°º", "5å…¬å°º", "7.5å…¬å°º"] },
            { type: "é€Ÿç‡å•é¡Œ", q: "ç”²è»Š60km/æ™‚ï¼Œä¹™è»Š80km/æ™‚ï¼Œç›¸å‘è¡Œé§›ã€‚æ©‹é•·70kmï¼Œå¹¾å°æ™‚å¾Œç›¸é‡ï¼Ÿ", ans: "0.5å°æ™‚", options: ["0.5å°æ™‚", "2å°æ™‚", "1å°æ™‚", "1.5å°æ™‚"] },
            { type: "é€Ÿç‡å•é¡Œ", q: "èŠ±èŠ±(5m/ç§’)å’Œå°è(4m/ç§’)å¾åŒåœ°<b>åæ–¹å‘</b>èµ·è·‘ï¼Œ10ç§’å¾Œç›¸è·å¤šå°‘ï¼Ÿ", ans: "90å…¬å°º", options: ["90å…¬å°º", "10å…¬å°º", "45å…¬å°º", "50å…¬å°º"] },
            { type: "é€Ÿç‡å•é¡Œ", q: "æ°¸ç¦(210m/åˆ†)å’Œå¤©å®‰(180m/åˆ†)åŒåœ°åŒå‘å‡ºç™¼ï¼Œ<b>20åˆ†é˜å¾Œ</b>å…©äººç›¸è·å¤šå°‘ï¼Ÿ", ans: "600å…¬å°º", options: ["600å…¬å°º", "4200å…¬å°º", "3600å…¬å°º", "7800å…¬å°º"] },
            { type: "é€Ÿç‡å•é¡Œ", q: "å¤©å®‰åœ¨æ°¸ç¦å‰æ–¹900å…¬å°ºï¼Œæ°¸ç¦(210m/åˆ†)è¿½å¤©å®‰(180m/åˆ†)ï¼Œå¹¾åˆ†é˜è¿½ä¸Šï¼Ÿ", ans: "30åˆ†é˜", options: ["30åˆ†é˜", "10åˆ†é˜", "20åˆ†é˜", "45åˆ†é˜"] },
            { type: "é€Ÿç‡å•é¡Œ", q: "å°å”(3.2m/s)å…ˆè·‘30ç§’ï¼Œèè(4.8m/s)æ‰è¿½ã€‚èèè¦è¿½å¹¾ç§’ï¼Ÿ(æç¤º:å…ˆç®—å°å”è·‘äº†96m)", ans: "60ç§’", options: ["60ç§’", "40ç§’", "50ç§’", "30ç§’"] },

            // --- å¹´é½¡å•é¡Œ (å€æ•¸ã€å·®ä¸è®Š) ---
            { type: "å¹´é½¡å•é¡Œ", q: "çˆ¸çˆ¸ä»Šå¹´32æ­²ï¼Œå°ç«‹6æ­²ã€‚è«‹å• <b>å¹¾å¹´å¾Œ</b> çˆ¸çˆ¸çš„å¹´é½¡å‰›å¥½æ˜¯å°ç«‹çš„3å€ï¼Ÿ", ans: "7å¹´å¾Œ", options: ["7å¹´å¾Œ", "6å¹´å¾Œ", "5å¹´å¾Œ", "8å¹´å¾Œ"] },
            { type: "å¹´é½¡å•é¡Œ", q: "çˆ¸çˆ¸42æ­²ï¼Œå¼Ÿå¼Ÿ14æ­²ã€‚<b>å¹¾å¹´å‰</b> çˆ¸çˆ¸çš„å¹´é½¡æ˜¯å¼Ÿå¼Ÿçš„8å€ï¼Ÿ", ans: "10å¹´å‰", options: ["10å¹´å‰", "8å¹´å‰", "12å¹´å‰", "6å¹´å‰"] },
            { type: "å¹´é½¡å•é¡Œ", q: "çˆºçˆº51æ­²ï¼Œå¼Ÿå¼Ÿ6æ­²ã€‚ç•¶çˆºçˆºå¹´é½¡æ˜¯å¼Ÿå¼Ÿçš„6å€æ™‚ï¼Œå¼Ÿå¼Ÿå¹¾æ­²ï¼Ÿ", ans: "9æ­²", options: ["9æ­²", "8æ­²", "10æ­²", "12æ­²"] },
            { type: "å¹´é½¡å•é¡Œ", q: "çˆºçˆº51æ­²ï¼Œçˆ¸çˆ¸30æ­²ã€‚<b>å¹¾å¹´å‰</b> çˆºçˆºçš„å¹´é½¡æ˜¯çˆ¸çˆ¸çš„8å€ï¼Ÿ", ans: "27å¹´å‰", options: ["27å¹´å‰", "21å¹´å‰", "10å¹´å‰", "15å¹´å‰"] },
            { type: "å¹´é½¡å•é¡Œ", q: "å”å”31æ­²ï¼Œé˜¿å¾·4æ­²ã€‚ç•¶å”å”æ˜¯é˜¿å¾·çš„4å€æ™‚ï¼Œå”å”å¹¾æ­²ï¼Ÿ", ans: "36æ­²", options: ["36æ­²", "32æ­²", "40æ­²", "28æ­²"] },
            { type: "å¹´é½¡å•é¡Œ", q: "å¤–å©†61æ­²ï¼Œå¦¹å¦¹4æ­²ã€‚<b>å¹¾å¹´å¾Œ</b> å¤–å©†æ˜¯å¦¹å¦¹çš„4å€ï¼Ÿ", ans: "15å¹´å¾Œ", options: ["15å¹´å¾Œ", "10å¹´å¾Œ", "12å¹´å¾Œ", "19å¹´å¾Œ"] },
            { type: "å¹´é½¡å•é¡Œ", q: "åª½åª½31æ­²ï¼Œå¦¹å¦¹4æ­²ã€‚<b>å¹¾å¹´å‰</b> åª½åª½æ˜¯å¦¹å¦¹çš„10å€ï¼Ÿ", ans: "1å¹´å‰", options: ["1å¹´å‰", "2å¹´å‰", "3å¹´å‰", "å‰›å‡ºç”Ÿ"] },
            { type: "å¹´é½¡å•é¡Œ", q: "å½©é³³8æ­²ï¼Œåª½åª½34æ­²ã€‚ç•¶åª½åª½æ˜¯å½©é³³çš„3å€æ™‚ï¼Œå½©é³³å¹¾æ­²ï¼Ÿ", ans: "13æ­²", options: ["13æ­²", "10æ­²", "26æ­²", "12æ­²"] },
            { type: "å¹´é½¡å•é¡Œ", q: "çˆºçˆº64æ­²ï¼Œå°å¥‡14æ­²ã€‚<b>å¹¾å¹´å‰</b> çˆºçˆºæ˜¯å°å¥‡çš„6å€ï¼Ÿ", ans: "4å¹´å‰", options: ["4å¹´å‰", "6å¹´å‰", "10å¹´å‰", "2å¹´å‰"] },
            
            // --- å¹³å‡å•é¡Œ ---
            { type: "å¹³å‡å•é¡Œ", q: "é˜¿é›„èŠ±500ï¼Œå°éœèŠ±300ï¼Œå¤§èƒ–èŠ±400ã€‚å¹³å‡æ¯äººèŠ±å¤šå°‘ï¼Ÿ", ans: "400å…ƒ", options: ["400å…ƒ", "350å…ƒ", "450å…ƒ", "300å…ƒ"] },
            { type: "å¹³å‡å•é¡Œ", q: "1ç­5ç”·å¹³å‡è·³33ä¸‹ï¼Œ3å¥³å¹³å‡è·³å¹¾ä¸‹ï¼Ÿ(å·²çŸ¥å…¨ç­8äººå¹³å‡30ä¸‹)", ans: "25ä¸‹", options: ["25ä¸‹", "20ä¸‹", "35ä¸‹", "30ä¸‹"] },
            { type: "å¹³å‡å•é¡Œ", q: "å°å¨Ÿåœ‹æ•¸ç¤¾ä¸‰ç§‘å¹³å‡87ï¼Œè‡ªç„¶95ã€‚å››ç§‘å¹³å‡å¹¾åˆ†ï¼Ÿ", ans: "89åˆ†", options: ["89åˆ†", "90åˆ†", "91åˆ†", "88åˆ†"] },
            { type: "å¹³å‡å•é¡Œ", q: "ä¾¿ç•¶åº—5å¤©å¹³å‡è³£150å€‹ã€‚ç¬¬ä¸€å¤©è³£198å€‹ï¼Œå‰©ä¸‹å››å¤©å¹³å‡è³£å¹¾å€‹ï¼Ÿ", ans: "138å€‹", options: ["138å€‹", "140å€‹", "120å€‹", "150å€‹"] },
            { type: "å¹³å‡å•é¡Œ", q: "åœ“åœ“èŠ±341ï¼Œäº®äº®èŠ±256ï¼Œå¤šå¤šèŠ±297ã€‚å¹³å‡æ¯äººå¤šå°‘ï¼Ÿ", ans: "298å…ƒ", options: ["298å…ƒ", "300å…ƒ", "290å…ƒ", "310å…ƒ"] },
            { type: "å¹³å‡å•é¡Œ", q: "ç¾çªèŠ±780ï¼Œç‰ç²èŠ±120ï¼Œå®‰æ…ˆèŠ±246ã€‚å¹³å‡æ¯äººå¤šå°‘ï¼Ÿ", ans: "382å…ƒ", options: ["382å…ƒ", "350å…ƒ", "400å…ƒ", "360å…ƒ"] },
            { type: "å¹³å‡å•é¡Œ", q: "å‰3å¤©å¹³å‡è³£207å€‹éºµåŒ…ï¼ŒåŠ ç¬¬4å¤©å¾Œå¹³å‡è®Š215å€‹ã€‚ç¬¬4å¤©è³£å¹¾å€‹ï¼Ÿ", ans: "239å€‹", options: ["239å€‹", "240å€‹", "215å€‹", "220å€‹"] },
            { type: "å¹³å‡å•é¡Œ", q: "è·³é æ¯”è³½ï¼š3äººå¹³å‡131cmï¼Œå¦å¤–4äººå¹³å‡152cmã€‚å…¨ç­7äººå¹³å‡å¹¾å…¬åˆ†ï¼Ÿ", ans: "143å…¬åˆ†", options: ["143å…¬åˆ†", "140å…¬åˆ†", "145å…¬åˆ†", "150å…¬åˆ†"] },

            // --- é‚è¼¯èˆ‡æ‡‰ç”¨ ---
            { type: "é‚è¼¯å•é¡Œ", q: "é›å’Œè±¬å…±15éš»ï¼Œè…³å…±48éš»ã€‚è«‹å•è±¬æœ‰å¹¾éš»ï¼Ÿ", ans: "9éš»", options: ["9éš»", "6éš»", "8éš»", "7éš»"] },
            { type: "é‚è¼¯å•é¡Œ", q: "ç•ªèŒ„æ±45å…ƒï¼ŒæŸ³æ©™æ±35å…ƒï¼Œå…±è²·7æ¯èŠ±265å…ƒã€‚ç•ªèŒ„æ±å¹¾æ¯ï¼Ÿ", ans: "2æ¯", options: ["2æ¯", "3æ¯", "4æ¯", "5æ¯"] },
            { type: "é‚è¼¯å•é¡Œ", q: "å°å®¶æœ‰120å…ƒï¼Œå°è±ªçµ¦å°å®¶80å…ƒå¾Œå…©äººéŒ¢ä¸€æ¨£å¤šã€‚å°è±ªåŸæœ‰å¤šå°‘å…ƒï¼Ÿ", ans: "280å…ƒ", options: ["280å…ƒ", "200å…ƒ", "160å…ƒ", "240å…ƒ"] },
            { type: "é‚è¼¯å•é¡Œ", q: "å°ç¾æ¯”å°å¦‚å¤§3æ­²ï¼Œå…©äººå¹´é½¡å’Œ25æ­²ã€‚å°ç¾å¹¾æ­²ï¼Ÿ", ans: "14æ­²", options: ["14æ­²", "11æ­²", "12æ­²", "13æ­²"] },
            { type: "é‚è¼¯å•é¡Œ", q: "ç”²åˆ°ä¹™5æ¢è·¯ï¼Œä¹™åˆ°ä¸™4æ¢è·¯ã€‚ç”²ç¶“ä¹™åˆ°ä¸™å¹¾ç¨®èµ°æ³•ï¼Ÿ", ans: "20ç¨®", options: ["20ç¨®", "9ç¨®", "15ç¨®", "25ç¨®"] },
            { type: "é‚è¼¯å•é¡Œ", q: "ç”²è¢‹ç±³ç”¨æ‰160gï¼Œä¹™è¢‹å¤šè£160gå¾Œä¸€æ¨£é‡ã€‚åŸä¾†ç”²ä¹™å·®å¤šå°‘ï¼Ÿ", ans: "320g", options: ["320g", "160g", "0g", "80g"] },
            { type: "é‚è¼¯å•é¡Œ", q: "ç‹—å’Œé´¨å…±8éš»ï¼Œè…³å…±22éš»ã€‚ç‹—æœ‰å¹¾éš»ï¼Ÿ", ans: "3éš»", options: ["3éš»", "5éš»", "4éš»", "2éš»"] },
            { type: "é‚è¼¯å•é¡Œ", q: "5å…ƒå’Œ8å…ƒç³–æœå…±25é¡†ï¼ŒèŠ±170å…ƒã€‚5å…ƒç³–æœè²·å¹¾é¡†ï¼Ÿ", ans: "10é¡†", options: ["10é¡†", "15é¡†", "12é¡†", "14é¡†"] }
        ];

        const relics = ["ğŸº", "ğŸ—¿", "âš°ï¸", "ğŸ›ï¸", "ğŸ‘‘", "ğŸ•°ï¸"];
        const repairTools = [
            { icon: "ğŸ”¨", name: "hammer" },
            { icon: "ğŸ”§", name: "wrench" },
            { icon: "ğŸª¡", name: "needle" },
            { icon: "ğŸ–Œï¸", name: "brush" }
        ];

        let state = {
            isPlaying: false,
            score: 0,
            strikes: 0,
            time: 90,
            timerId: null,
            currentQ: null,
            progress: 0,
            relicIndex: 0,
            availableQuestions: []
        };

        const els = {
            dropZone: document.getElementById('drop-zone'),
            relicTarget: document.getElementById('relic-target'),
            toolsContainer: document.getElementById('tools-container'),
            qText: document.getElementById('q-text'),
            qCat: document.getElementById('q-category'),
            progressCircle: document.getElementById('progress-circle'),
            errorMsg: document.getElementById('error-msg'),
            correctVal: document.getElementById('correct-val'),
            light1: document.getElementById('light-1'),
            light2: document.getElementById('light-2'),
            score: document.getElementById('score'),
            timer: document.getElementById('timer'),
            startBtn: document.getElementById('start-btn'),
            username: document.getElementById('username'),
            startScreen: document.getElementById('start-screen'),
            // Rank related
            showRankBtn: document.getElementById('show-rank-btn'),
            rankModal: document.getElementById('rank-modal'),
            closeRankBtn: document.getElementById('close-rank-btn'),
            rankList: document.getElementById('rank-list'),
            endScreen: document.getElementById('end-screen'),
            finalScore: document.getElementById('final-score')
        };

        // --- Event Listeners ---
        els.startBtn.addEventListener('click', startGame);
        
        els.showRankBtn.addEventListener('click', () => {
            updateRankDisplay();
            els.rankModal.style.display = 'block';
        });
        
        els.closeRankBtn.addEventListener('click', () => {
            els.rankModal.style.display = 'none';
        });

        // --- Game Logic ---

        function initQuestions() {
            // æ·±æ‹·è²ä¸¦æ´—ç‰Œ
            state.availableQuestions = JSON.parse(JSON.stringify(fullQuestionBank));
            shuffleArray(state.availableQuestions);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startGame() {
            const name = els.username.value.trim();
            if(!name) { 
                alert("è«‹è¼¸å…¥ä»£è™Ÿæˆ–åå­—æ‰èƒ½é–‹å§‹ä»»å‹™!"); 
                return; 
            }
            els.startScreen.style.display = 'none';
            state.isPlaying = true;
            state.score = 0;
            state.time = 90;
            
            // Initial Shuffle
            initQuestions();

            state.timerId = setInterval(() => {
                state.time--;
                els.timer.innerText = state.time;
                if(state.time <= 0) endGame();
            }, 1000);
            loadRelic();
        }

        function loadRelic() {
            state.strikes = 0;
            state.progress = 0;
            updateStrikes();
            updateProgress(0);
            els.relicTarget.innerText = relics[state.relicIndex % relics.length];
            els.relicTarget.style.opacity = 1;
            els.relicTarget.style.transform = "scale(1)";
            els.relicTarget.className = "relic-img"; 
            nextQuestion();
        }

        function nextQuestion() {
            // å¦‚æœé¡Œåº«ç©ºäº†ï¼Œé‡æ–°å¡«å……ä¸¦æ´—ç‰Œ (ç„¡é™å¾ªç’°)
            if (state.availableQuestions.length === 0) {
                initQuestions();
            }
            
            state.currentQ = state.availableQuestions.pop();
            els.qCat.innerText = state.currentQ.type;
            els.qText.innerHTML = state.currentQ.q; 
            
            els.toolsContainer.innerHTML = "";
            let options = [...state.currentQ.options].sort(() => Math.random() - 0.5);
            
            options.forEach((opt, index) => {
                const toolData = repairTools[index % 4]; 
                const card = document.createElement('div');
                card.className = 'tool-card';
                card.innerHTML = `
                    <div class="tool-icon">${toolData.icon}</div>
                    <div class="tool-value">${opt}</div>
                `;
                addDragLogic(card, opt, toolData.icon);
                els.toolsContainer.appendChild(card);
            });
        }

        function addDragLogic(el, value, iconChar) {
            let isDragging = false;
            const start = (e) => {
                if(!state.isPlaying) return;
                isDragging = true;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                el.classList.add('dragging');
                updatePos(clientX, clientY);
            };
            const move = (e) => {
                if(!isDragging) return;
                e.preventDefault(); 
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                updatePos(clientX, clientY);
            };
            const end = (e) => {
                if(!isDragging) return;
                isDragging = false;
                el.classList.remove('dragging');
                el.style.position = '';
                el.style.left = '';
                el.style.top = '';
                const dropRect = els.dropZone.getBoundingClientRect();
                const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                if(clientX > dropRect.left && clientX < dropRect.right &&
                   clientY > dropRect.top && clientY < dropRect.bottom) {
                    checkAnswer(value, iconChar);
                }
            };
            const updatePos = (x, y) => {
                el.style.left = (x - 45) + 'px'; 
                el.style.top = (y - 50) + 'px';
            };
            el.addEventListener('mousedown', start);
            el.addEventListener('touchstart', start, {passive: false});
            window.addEventListener('mousemove', move);
            window.addEventListener('touchmove', move, {passive: false});
            window.addEventListener('mouseup', end);
            window.addEventListener('touchend', end);
        }

        function checkAnswer(val, toolIcon) {
            if(val === state.currentQ.ans) {
                playRepairEffect(toolIcon);
                state.progress += 34; 
                updateProgress(state.progress);
                if(state.progress >= 100) {
                    state.score++;
                    state.relicIndex++;
                    state.time += 5;
                    els.score.innerText = state.score;
                    els.relicTarget.style.transform = "scale(1.2) translateY(-20px)";
                    els.relicTarget.style.opacity = "0";
                    setTimeout(loadRelic, 800);
                } else {
                    setTimeout(nextQuestion, 600);
                }
            } else {
                state.strikes++;
                updateStrikes();
                playCrackEffect(state.currentQ.ans);
                if(state.strikes >= 2) {
                    // Structure collapsed, move to next relic but no points
                    state.relicIndex++; 
                    setTimeout(() => {
                        els.errorMsg.style.display = 'none';
                        loadRelic(); 
                    }, 1500);
                } else {
                    setTimeout(nextQuestion, 1500);
                }
            }
        }

        function playRepairEffect(icon) {
            const effect = document.createElement('div');
            effect.innerText = icon;
            effect.className = 'repair-anim';
            effect.style.left = '50%';
            effect.style.top = '40%';
            effect.style.transform = 'translate(-50%, -50%)';
            els.dropZone.appendChild(effect);
            setTimeout(() => effect.remove(), 800);
        }

        function playCrackEffect(correctAnswer) {
            els.correctVal.innerText = correctAnswer;
            els.errorMsg.style.display = 'block';
            els.relicTarget.classList.add('relic-cracked');
            els.dropZone.animate([
                { transform: 'translateX(-5px)' },
                { transform: 'translateX(5px)' },
                { transform: 'translateX(-5px)' }
            ], { duration: 200, iterations: 3 });
            setTimeout(() => {
                els.errorMsg.style.display = 'none';
            }, 1400);
        }

        function updateStrikes() {
            els.light1.classList.remove('active');
            els.light2.classList.remove('active');
            if(state.strikes >= 1) els.light1.classList.add('active');
            if(state.strikes >= 2) els.light2.classList.add('active');
        }

        function updateProgress(percent) {
            const radius = 110; 
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (Math.min(percent, 100) / 100) * circumference;
            els.progressCircle.style.strokeDasharray = circumference;
            els.progressCircle.style.strokeDashoffset = offset;
        }

        function endGame() {
            state.isPlaying = false;
            clearInterval(state.timerId);
            
            // Save Score
            saveScore(els.username.value, state.score);

            els.endScreen.style.display = 'flex';
            els.finalScore.innerText = state.score;
        }

        // --- Leaderboard LocalStorage Logic ---
        function saveScore(name, score) {
            let ranks = JSON.parse(localStorage.getItem('jessieMathRank')) || [];
            ranks.push({ name: name, score: score, date: new Date().toLocaleDateString() });
            ranks.sort((a, b) => b.score - a.score);
            ranks = ranks.slice(0, 5); // Keep top 5
            localStorage.setItem('jessieMathRank', JSON.stringify(ranks));
        }

        function updateRankDisplay() {
            const ranks = JSON.parse(localStorage.getItem('jessieMathRank')) || [];
            els.rankList.innerHTML = "";
            if (ranks.length === 0) {
                els.rankList.innerHTML = "<li style='text-align:center; color:#666;'>æš«ç„¡ç´€éŒ„ï¼Œå¿«ä¾†æŒ‘æˆ°ï¼</li>";
                return;
            }
            ranks.forEach((r, i) => {
                const li = document.createElement('li');
                li.className = 'rank-item';
                li.innerHTML = `
                    <span>#${i+1} ${r.name}</span>
                    <span>${r.date}</span>
                    <span>${r.score} åˆ†</span>
                `;
                els.rankList.appendChild(li);
            });
        }
    </script>
</body>
</html>